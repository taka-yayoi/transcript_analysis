# 文字起こし感情分析パイプライン

文字起こしファイルから会話の感情を分析し、発話者間の影響関係を可視化するDatabricks Notebookです。Claude Sonnet 4.5を使用した高精度な感情分析により、会議やインタビューなどの会話データから感情の推移と発話者間の影響関係を明らかにします。

## 主な機能

- **高精度な感情分析**: Claude Sonnet 4.5による自然言語理解
- **並列処理**: Spark UDFによる高速分析
- **発話者別可視化**: 時系列推移、感情分布、スコア分布を発話者別に表示
- **感情変動分析**: 急激な感情変化とその原因となった発話を特定
- **影響力分析**: どの発話者が他者の感情に最も影響を与えているかを定量化
- **インタラクティブな可視化**: Plotlyによる動的グラフ

## セットアップ

1. Databricks Workspaceに`transcript_sentiment_analysis.py`をインポート
2. クラスターにアタッチ（MLランタイム推奨）
3. 必要なパッケージをインストール（ノートブック内で自動実行）

## 実行手順

### 1. 文字起こしファイルの準備

Volumeにファイルをアップロード: `/Volumes/takaakiyayoi_catalog/movie_analysis/movie_data/`

ファイルフォーマット:
```
[発話者名] HH:MM:SS
発話内容テキスト
```

#### フォーマット例

```
[田中健太] 00:00:07
おはようございます。今日の会議を始めます。

[佐藤美咲] 00:00:15
おはようございます。よろしくお願いします。

[田中健太] 00:00:23
本日のアジェンダは3つあります。
```

#### サンプルファイル

リポジトリには`transcript_sample.txt`というサンプルファイルが含まれています。
このファイルを使って、すぐに分析を試すことができます。

サンプルファイルのアップロード方法:
1. Databricks UIで Catalog → Volumes を開く
2. 対象のVolume（`/Volumes/takaakiyayoi_catalog/movie_analysis/movie_data/`）を開く
3. 「Upload Files」をクリック
4. `transcript_sample.txt`をアップロード
5. ノートブックのウィジェットで`transcript_sample.txt`を指定

#### フォーマット仕様

- **タイムスタンプ行**: `[発話者名] HH:MM:SS`
- **発話内容行**: タイムスタンプの次の行に発話内容
- **空行**: 各発話の間に空行を入れる（推奨）

### 2. ノートブックの実行

1. ウィジェットでファイル名を指定
2. セルを順番に実行

### 3. 結果の確認

以下の可視化と分析結果が表示されます:

- 時系列推移グラフ（発話者別色分け）
- 感情分布の円グラフ（全体・発話者別）
- 感情スコアのヒストグラム（全体・発話者別）
- 箱ひげ図による統計比較
- 発話者別の平均感情スコア
- 感情変動イベントの詳細
- 発話者別の影響力分析

## 分析の流れ

1. **文字起こしファイルの読み込み**
   - タイムスタンプ付き文字起こしを解析
   - 発話者名と時刻を抽出
   - セグメント単位でデータ構造化

2. **感情分析（並列処理）**
   - Claude Sonnet 4.5で各発話の感情を分析
   - 感情ラベル（ポジティブ/ネガティブ/中立）
   - 感情スコア（-1.0〜1.0）
   - 信頼度（0.0〜1.0）

3. **発話者別可視化**
   - 時系列推移グラフ（発話者別色分け）
   - 感情分布の円グラフ
   - ヒストグラムと箱ひげ図
   - 平均スコアの棒グラフ

4. **感情変動分析**
   - 急激な感情変化の検出
   - トリガーとなった発話の特定
   - 変化前・トリガー・変化後の文脈表示

5. **影響力分析**
   - 発話者別の感情的影響力を定量化
   - ポジティブ/ネガティブな影響の内訳
   - 影響回数と合計影響度

## 使用モデル

- **Claude Sonnet 4.5** (`databricks-claude-sonnet-4-5`)
  - Databricks Foundation Model APIを使用
  - 高精度な日本語感情理解
  - 低温度設定（0.1）で安定した分析結果

## 技術スタック

- Python 3.x
- PySpark (Databricks Runtime)
- MLflow (Foundation Model API)
- Plotly (可視化)
- Pandas (データ処理)

## 活用例

### 会議分析
参加者の感情推移を追跡し、議論がポジティブ/ネガティブに転じたポイントを特定。建設的な会議運営に活用。

### カスタマーサポート
顧客満足度の変化点を分析し、どのオペレーターの発言が満足度に影響を与えたかを把握。

### インタビュー分析
インタビュアーと被験者の感情の相互作用を可視化し、効果的な質問技法を分析。

### チームダイナミクス
メンバー間の影響関係を理解し、チームの心理的安全性やコミュニケーションパターンを改善。

## 設定とカスタマイズ

### 感情変動の閾値

感情変動として検出する閾値を調整できます（`transcript_sentiment_analysis.py`の591行目）:

```python
emotion_changes_df = analyze_emotion_changes(emotion_df, threshold=0.3)
```

推奨値:
- `0.1`: 微細な変化も検出（ノイズが多い）
- `0.3`: バランスの取れた検出（デフォルト）
- `0.5`: 大きな変化のみ検出

### 出力先Volume

環境に応じて出力先を変更できます（`transcript_sentiment_analysis.py`の53行目）:

```python
OUTPUT_VOLUME = "/Volumes/takaakiyayoi_catalog/movie_analysis/movie_data"
```

### 並列処理

Sparkが自動的にクラスターリソースに応じて最適化します。
より高速に処理したい場合は、クラスターサイズを増やしてください。

## トラブルシューティング

### ファイルが読み込めない

- ファイルのエンコーディングがUTF-8であることを確認
- フォーマットが正しいか確認（タイムスタンプ形式 `[発話者名] HH:MM:SS`）
- Volumeパスが正しいか確認

### 感情分析が遅い

- クラスターサイズを増やす
- APIレート制限に達していないか確認

### 感情変動が検出されない

- 閾値を下げる（0.2以下に設定）
- データに十分な発話があるか確認
- 発話者が2人以上いるか確認

## サポート

問題が発生した場合は、以下を確認してください:
- Databricks Foundation Model APIの利用可能性
- Claude Sonnet 4.5エンドポイントへのアクセス権
- 必要なパッケージのインストール状況

## 今後の改善案

- [ ] 複数ファイルの一括分析機能
- [ ] リアルタイム音声文字起こし連携
- [ ] 感情以外の分析（トピック分析、キーワード抽出）
- [ ] レポート出力機能（PDF/Word）
- [ ] 比較分析機能（複数会議の比較）
- [ ] 多言語対応
- [ ] カスタム感情カテゴリ設定

## 貢献

改善提案やバグ報告は歓迎します。

---

**Author**: Takaaki Yayoi
**Last Updated**: 2025-11-07
